<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Admin CSKH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    body { background: #f5f7fa; }
    .cskh-admin-main { display: flex; gap: 24px; }
    .cskh-admin-list { background: #f6f7fb; border-radius: 16px; padding: 18px 10px 10px 10px; max-width: 340px; min-width: 220px; box-shadow: 0 2px 16px rgba(0,0,0,0.08);}
    .cskh-admin-chatbox { flex:1; background: #f9fafc; border-radius: 18px; padding: 22px 18px 12px 18px; min-height: 340px; max-height: 520px; overflow-y: auto; box-shadow: 0 4px 24px rgba(0,0,0,0.08);}
    #adminMsgs { flex: 1; overflow-y: auto; min-height: 220px; max-height: 350px;}
    .cskh-input { position: sticky; bottom: 0; background: #fff; }
    #adminMsgInput { resize: none; }
    @media (max-width: 900px) {
      .cskh-admin-main { flex-direction: column; }
      .cskh-admin-list, .cskh-admin-chatbox { max-width: 100%; }
    }
  </style>
</head>
<body>
<div class="cskh-box">
  <div class="cskh-header">
    <span>üéß Admin CSKH</span>
  </div>
  <div id="adminLogin" class="cskh-login">
    <h3>ƒêƒÉng nh·∫≠p qu·∫£n tr·ªã vi√™n</h3>
    <input type="password" id="adminPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u admin...">
    <button onclick="loginAdmin()">ƒêƒÉng nh·∫≠p</button>
  </div>
  <div id="adminPanel" style="display:none;">
    <div class="cskh-admin-main">
      <div class="cskh-admin-list" id="userList"></div>
      <div class="cskh-admin-chatbox" id="adminChatBox" style="display:none;flex-direction:column;">
        <div class="cskh-admin-header" id="adminChatHeader"></div>
        <div id="adminMsgs"></div>
        <div id="adminTyping" class="cskh-admin-typing" style="display:none;">
          <span>Kh√°ch ƒëang nh·∫≠p</span>
          <span class="cskh-typing-dot"></span><span class="cskh-typing-dot"></span><span class="cskh-typing-dot"></span>
        </div>
        <form id="adminInputForm" class="cskh-input" autocomplete="off">
          <label>
            <input type="file" id="adminImgInput" accept="image/*" style="display:none;">
            <span>üìé</span>
          </label>
          <textarea id="adminMsgInput" placeholder="Nh·∫≠p tr·∫£ l·ªùi..." autocomplete="off" rows="1" style="resize:none;flex:1;border:1px solid #e5e7eb;border-radius:7px;padding:10px 13px;font-size:1rem;"></textarea>
          <button type="submit">G·ª≠i</button>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
let adminAuth = '';
let currentClient = '';
let chatPolling = null;
let typingTimer = null;
let typingStatus = false;
let typingTimeoutUser = null;
let lastMsgsLength = 0;
function loginAdmin() {
  let pass = document.getElementById('adminPass').value;
  adminAuth = btoa('admin:' + pass);
  fetch('/api/allchats', {headers:{authorization:'Basic '+adminAuth}})
    .then(r=>r.json()).then(list=>{
      if (Array.isArray(list)) {
        document.getElementById('adminLogin').style.display = 'none';
        document.getElementById('adminPanel').style.display = '';
        loadUserList();
        pollUserList();
      } else {
        alert('Sai m·∫≠t kh·∫©u!');
      }
    });
}
function loadUserList() {
  fetch('/api/allchats', {headers:{authorization:'Basic '+adminAuth}})
    .then(r=>r.json())
    .then(list=>{
      let html = '';
      list.forEach(u=>{
        html += `<div class="cskh-admin-user${u.unread?' unread':''}" onclick="openChat('${u.clientId}','${u.name||'·∫®n danh'}')">
          <span class="dot${u.online?'':' offline'}"></span>
          <span style="flex:1;">${u.name||'·∫®n danh'}</span>
          <span style="font-size:0.93em;color:#888;">${u.lastMsg ? (new Date(u.lastMsg.time)).toLocaleTimeString() : ''}</span>
          ${u.unread ? '<span style="color:#4f8cff;margin-left:8px;">Ch∆∞a tr·∫£ l·ªùi</span>' : ''}
        </div>`;
      });
      document.getElementById('userList').innerHTML = html || '<div style="color:#888;">Ch∆∞a c√≥ kh√°ch n√†o chat</div>';
    });
}
function openChat(clientId, name) {
  // T·∫Øt typing ·ªü kh√°ch c≈© n·∫øu c√≥
  if (currentClient) sendTyping(false);
  currentClient = clientId;
  document.getElementById('adminChatBox').style.display = 'flex';
  document.getElementById('adminChatHeader').innerHTML = `<span>${name}</span> <span id="adminOnlineDot" class="dot"></span>`;
  loadChat(true);
  if (chatPolling) clearInterval(chatPolling);
  chatPolling = setInterval(()=>loadChat(false), 1200);
}
function loadChat(scrollToEnd = false) {
  fetch('/api/chat?clientId='+currentClient, {headers:{authorization:'Basic '+adminAuth}})
    .then(r=>r.json())
    .then(arr=>{
      let chatDiv = document.getElementById('adminMsgs');
      let atBottom = chatDiv.scrollHeight - chatDiv.scrollTop - chatDiv.clientHeight < 40;
      let html = '';
      arr.forEach(m=>{
        let bubble = m.msg.startsWith('img:') ? `<img src="${m.msg.slice(4)}" alt="img">` : m.msg.replace(/</g,'&lt;').replace(/\n/g,'<br>');
        if (m.role === 'user') html += `<div class="cskh-msg"><div class="bubble">${bubble}</div></div>`;
        else html += `<div class="cskh-msg user"><div class="bubble">${bubble}</div></div>`;
      });
      chatDiv.innerHTML = html;
      // Ch·ªâ scroll n·∫øu v·ª´a g·ª≠i/nh·∫≠n tin nh·∫Øn m·ªõi, ho·∫∑c l·∫ßn ƒë·∫ßu m·ªü chat
      if (scrollToEnd || atBottom || arr.length !== lastMsgsLength) chatDiv.scrollTop = chatDiv.scrollHeight;
      lastMsgsLength = arr.length;
      pollTyping();
    });
}
document.getElementById('adminInputForm').onsubmit = function(e) {
  e.preventDefault();
  let msg = document.getElementById('adminMsgInput').value.trim();
  if (!msg) return;
  fetch('/api/adminsend', {
    method:'POST',
    headers:{'Content-Type':'application/json',authorization:'Basic '+adminAuth},
    body: JSON.stringify({clientId:currentClient, msg})
  }).then(()=>{
    document.getElementById('adminMsgInput').value='';
    loadChat(true);
    autoResize();
    sendTyping(false);
    typingStatus = false;
  });
};
document.getElementById('adminMsgInput').addEventListener('input', ()=>{
  if (!typingStatus) {
    sendTyping(true);
    typingStatus = true;
  }
  clearTimeout(typingTimer);
  typingTimer = setTimeout(()=>{
    sendTyping(false);
    typingStatus = false;
  }, 1200);
  autoResize();
});
function autoResize() {
  let input = document.getElementById('adminMsgInput');
  input.style.height = "auto";
  input.style.height = (input.scrollHeight) + "px";
}
function sendTyping(typing) {
  if (!currentClient) return;
  fetch('/api/admintyping', {
    method:'POST',
    headers:{'Content-Type':'application/json',authorization:'Basic '+adminAuth},
    body: JSON.stringify({clientId:currentClient, typing})
  });
}
document.getElementById('adminImgInput').onchange = function() {
  if (!this.files[0]) return;
  let fd = new FormData();
  fd.append('file', this.files[0]);
  fetch('/api/upload', {method:'POST', body:fd})
    .then(r=>r.json())
    .then(data=>{
      if (data.url) {
        fetch('/api/adminsend', {
          method:'POST',
          headers:{'Content-Type':'application/json',authorization:'Basic '+adminAuth},
          body: JSON.stringify({clientId:currentClient, msg:'img:' + data.url})
        }).then(()=>loadChat(true));
      }
    });
};
document.querySelector('#adminInputForm label').onclick = ()=>document.getElementById('adminImgInput').click();

let pollTimer = null;
function pollUserList() {
  loadUserList();
  pollTimer = setTimeout(pollUserList, 2000);
}
let pollTypingTimer = null;
function pollTyping() {
  fetch('/api/allchats', {headers:{authorization:'Basic '+adminAuth}})
    .then(r=>r.json()).then(list=>{
      let chat = list.find(c=>c.clientId===currentClient);
      document.getElementById('adminOnlineDot').className = 'dot' + (chat && chat.online ? '' : ' offline');
      if (chat && chat.typing) {
        document.getElementById('adminTyping').style.display = '';
        clearTimeout(typingTimeoutUser);
        typingTimeoutUser = setTimeout(()=>{document.getElementById('adminTyping').style.display='none';}, 3000);
      } else {
        document.getElementById('adminTyping').style.display = 'none';
      }
      pollTypingTimer = setTimeout(pollTyping, 1200);
    });
}
window.loginAdmin = loginAdmin;
window.openChat = openChat;
</script>
</body>
</html>
