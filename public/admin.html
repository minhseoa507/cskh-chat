<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Admin CSKH - Messenger Style</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="admin-mess-container">
  <div class="admin-mess-sidebar" id="userList"></div>
  <div class="admin-mess-chatpanel" id="chatPanel">
    <div class="admin-mess-empty" id="emptyPanel">
      <div class="admin-mess-empty-icon">üí¨</div>
      <div class="admin-mess-empty-text">Ch·ªçn m·ªôt kh√°ch ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán</div>
    </div>
    <div class="admin-mess-chatbox" id="chatBox" style="display:none;">
      <div class="admin-mess-chat-header" id="chatHeader"></div>
      <div class="admin-mess-messages" id="messages"></div>
      <div id="adminTyping" class="admin-mess-typing" style="display:none;">
        <span>Kh√°ch ƒëang nh·∫≠p</span>
        <span class="cskh-typing-dot"></span><span class="cskh-typing-dot"></span><span class="cskh-typing-dot"></span>
      </div>
      <form id="adminInputForm" class="admin-mess-input" autocomplete="off">
        <label>
          <input type="file" id="adminImgInput" accept="image/*" style="display:none;">
          <span>üìé</span>
        </label>
        <input type="text" id="adminMsgInput" placeholder="Nh·∫≠p tr·∫£ l·ªùi..." autocomplete="off">
        <button type="submit">G·ª≠i</button>
      </form>
    </div>
  </div>
</div>

<div class="admin-mess-login" id="adminLogin">
  <div class="admin-mess-login-box">
    <h3>ƒêƒÉng nh·∫≠p qu·∫£n tr·ªã vi√™n</h3>
    <input type="password" id="adminPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u admin...">
    <button onclick="loginAdmin()">ƒêƒÉng nh·∫≠p</button>
  </div>
</div>

<script>
let adminAuth = '';
let currentClient = '';
let clientName = '';
let lastSeen = {};

function loginAdmin() {
  let pass = document.getElementById('adminPass').value;
  adminAuth = btoa('admin:' + pass);
  fetch('/api/allchats', {headers:{authorization:'Basic '+adminAuth}})
    .then(r=>r.json()).then(list=>{
      if (Array.isArray(list)) {
        document.getElementById('adminLogin').style.display = 'none';
        document.querySelector('.admin-mess-container').style.display = 'flex';
        loadUserList();
        pollUserList();
      } else {
        alert('Sai m·∫≠t kh·∫©u!');
      }
    });
}
function loadUserList() {
  fetch('/api/allchats', {headers:{authorization:'Basic '+adminAuth}})
    .then(r=>r.json())
    .then(list=>{
      let html = '';
      list.forEach(u=>{
        let active = (u.clientId === currentClient) ? ' active' : '';
        let online = u.online ? 'online' : 'offline';
        let lastMsg = u.lastMsg ? (u.lastMsg.msg.startsWith('img:') ? 'üñºÔ∏è ·∫¢nh' : u.lastMsg.msg) : '';
        let time = u.lastMsg ? new Date(u.lastMsg.time).toLocaleTimeString() : '';
        let unread = u.unread ? '<span class="admin-mess-unread">Ch∆∞a xem</span>' : '';
        html += `<div class="admin-mess-user${active}" onclick="openChat('${u.clientId}','${u.name||'·∫®n danh'}')">
          <div class="admin-mess-avatar ${online}"></div>
          <div class="admin-mess-userinfo">
            <div class="admin-mess-username">${u.name||'·∫®n danh'}</div>
            <div class="admin-mess-lastmsg">${lastMsg}</div>
          </div>
          <div class="admin-mess-meta">
            <div class="admin-mess-time">${time}</div>
            ${u.online ? '<div class="admin-mess-dot online"></div>' : '<div class="admin-mess-dot offline"></div>'}
            ${unread}
          </div>
        </div>`;
      });
      document.getElementById('userList').innerHTML = html || '<div style="color:#888;padding:30px 0;text-align:center;">Ch∆∞a c√≥ kh√°ch n√†o chat</div>';
    });
}
function openChat(clientId, name) {
  currentClient = clientId;
  clientName = name;
  document.getElementById('emptyPanel').style.display = 'none';
  document.getElementById('chatBox').style.display = '';
  document.getElementById('chatHeader').innerHTML = `<span>${name}</span>`;
  loadChat();
  loadUserList();
}
function loadChat() {
  fetch('/api/chat?clientId='+currentClient, {headers:{authorization:'Basic '+adminAuth}})
    .then(r=>r.json())
    .then(arr=>{
      let html = '';
      let lastUserMsgIdx = -1;
      arr.forEach((m,i)=>{
        let bubble = m.msg.startsWith('img:') ? `<img src="${m.msg.slice(4)}" alt="img">` : m.msg.replace(/</g,'&lt;').replace(/\n/g,'<br>');
        let seen = '';
        if (m.role === 'user') lastUserMsgIdx = i;
        if (m.role === 'admin' && i === arr.length-1) {
          seen = (lastSeen[currentClient]) ? '<div class="admin-mess-seen">ƒê√£ xem</div>' : '<div class="admin-mess-seen admin-mess-seen-unread">Ch∆∞a xem</div>';
        }
        if (m.role === 'user')
          html += `<div class="admin-mess-msg user"><div class="bubble">${bubble}</div></div>`;
        else
          html += `<div class="admin-mess-msg admin"><div class="bubble">${bubble}${seen}</div></div>`;
      });
      document.getElementById('messages').innerHTML = html;
      document.getElementById('messages').scrollTop = 99999;
      pollTyping();
    });
}
document.getElementById('adminInputForm').onsubmit = function(e) {
  e.preventDefault();
  let msg = document.getElementById('adminMsgInput').value.trim();
  if (!msg) return;
  fetch('/api/adminsend', {
    method:'POST',
    headers:{'Content-Type':'application/json',authorization:'Basic '+adminAuth},
    body: JSON.stringify({clientId:currentClient, msg})
  }).then(()=>{document.getElementById('adminMsgInput').value='';loadChat();});
  sendTyping(false);
};
document.getElementById('adminMsgInput').addEventListener('input', ()=>{
  sendTyping(document.getElementById('adminMsgInput').value.length > 0);
});
function sendTyping(typing) {
  if (!currentClient) return;
  fetch('/api/admintyping', {
    method:'POST',
    headers:{'Content-Type':'application/json',authorization:'Basic '+adminAuth},
    body: JSON.stringify({clientId:currentClient, typing})
  });
}
document.getElementById('adminImgInput').onchange = function() {
  if (!this.files[0]) return;
  let fd = new FormData();
  fd.append('file', this.files[0]);
  fetch('/api/upload', {method:'POST', body:fd})
    .then(r=>r.json())
    .then(data=>{
      if (data.url) {
        fetch('/api/adminsend', {
          method:'POST',
          headers:{'Content-Type':'application/json',authorization:'Basic '+adminAuth},
          body: JSON.stringify({clientId:currentClient, msg:'img:' + data.url})
        }).then(()=>loadChat());
      }
    });
};
document.querySelector('#adminInputForm label').onclick = ()=>document.getElementById('adminImgInput').click();

let pollTimer = null;
function pollUserList() {
  fetch('/api/allchats', {headers:{authorization:'Basic '+adminAuth}})
    .then(r=>r.json())
    .then(list=>{
      lastSeen = {};
      list.forEach(u=>{
        if (!u.unread) lastSeen[u.clientId] = true;
      });
      loadUserList();
      pollTimer = setTimeout(pollUserList, 2000);
    });
}
let pollTypingTimer = null;
function pollTyping() {
  fetch('/api/allchats', {headers:{authorization:'Basic '+adminAuth}})
    .then(r=>r.json()).then(list=>{
      let chat = list.find(c=>c.clientId===currentClient);
      document.getElementById('adminTyping').style.display = (chat && chat.typing) ? '' : 'none';
      pollTypingTimer = setTimeout(pollTyping, 1200);
    });
}
window.loginAdmin = loginAdmin;
window.openChat = openChat;
document.querySelector('.admin-mess-container').style.display = 'none';
</script>
</body>
</html>
