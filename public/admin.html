<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Admin CSKH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    .cskh-admin-chatbox { display: flex; flex-direction: column; min-height: 320px; max-height: 500px; }
    #adminMsgs { flex: 1; overflow-y: auto; }
    .cskh-input { position: sticky; bottom: 0; background: #fff; }
    #adminMsgInput { resize: none; }
  </style>
</head>
<body>
<div class="cskh-box">
  <div class="cskh-header">
    <span>üéß Admin CSKH</span>
  </div>
  <div id="adminLogin" class="cskh-login">
    <h3>ƒêƒÉng nh·∫≠p qu·∫£n tr·ªã vi√™n</h3>
    <input type="password" id="adminPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u admin...">
    <button onclick="loginAdmin()">ƒêƒÉng nh·∫≠p</button>
  </div>
  <div id="adminPanel" style="display:none;">
    <div class="cskh-admin-list" id="userList"></div>
    <div class="cskh-admin-chatbox" id="adminChatBox" style="display:none;">
      <div class="cskh-admin-header" id="adminChatHeader"></div>
      <div id="adminMsgs"></div>
      <div id="adminTyping" class="cskh-admin-typing" style="display:none;">
        <span>Kh√°ch ƒëang nh·∫≠p</span>
        <span class="cskh-typing-dot"></span><span class="cskh-typing-dot"></span><span class="cskh-typing-dot"></span>
      </div>
      <form id="adminInputForm" class="cskh-input" autocomplete="off">
        <label>
          <input type="file" id="adminImgInput" accept="image/*" style="display:none;">
          <span>üìé</span>
        </label>
        <textarea id="adminMsgInput" placeholder="Nh·∫≠p tr·∫£ l·ªùi..." autocomplete="off" rows="1" style="resize:none;flex:1;border:1px solid #e5e7eb;border-radius:7px;padding:10px 13px;font-size:1rem;"></textarea>
        <button type="submit">G·ª≠i</button>
      </form>
    </div>
  </div>
</div>
<script>
let adminAuth = '';
let currentClient = '';
let chatPolling = null;
function loginAdmin() {
  let pass = document.getElementById('adminPass').value;
  adminAuth = btoa('admin:' + pass);
  fetch('/api/allchats', {headers:{authorization:'Basic '+adminAuth}})
    .then(r=>r.json()).then(list=>{
      if (Array.isArray(list)) {
        document.getElementById('adminLogin').style.display = 'none';
        document.getElementById('adminPanel').style.display = '';
        loadUserList();
        pollUserList();
      } else {
        alert('Sai m·∫≠t kh·∫©u!');
      }
    });
}
function loadUserList() {
  fetch('/api/allchats', {headers:{authorization:'Basic '+adminAuth}})
    .then(r=>r.json())
    .then(list=>{
      let html = '';
      list.forEach(u=>{
        html += `<div class="cskh-admin-user${u.unread?' unread':''}" onclick="openChat('${u.clientId}','${u.name||'·∫®n danh'}')">
          <span class="dot${u.online?'':' offline'}"></span>
          <span style="flex:1;">${u.name||'·∫®n danh'}</span>
          <span style="font-size:0.93em;color:#888;">${u.lastMsg ? (new Date(u.lastMsg.time)).toLocaleTimeString() : ''}</span>
          ${u.unread ? '<span style="color:#4f8cff;margin-left:8px;">Ch∆∞a tr·∫£ l·ªùi</span>' : ''}
        </div>`;
      });
      document.getElementById('userList').innerHTML = html || '<div style="color:#888;">Ch∆∞a c√≥ kh√°ch n√†o chat</div>';
    });
}
function openChat(clientId, name) {
  currentClient = clientId;
  document.getElementById('adminChatBox').style.display = '';
  document.getElementById('adminChatHeader').innerHTML = `<span>${name}</span> <span id="adminOnlineDot" class="dot"></span>`;
  loadChat();
  if (chatPolling) clearInterval(chatPolling);
  chatPolling = setInterval(loadChat, 1200);
}
function loadChat() {
  fetch('/api/chat?clientId='+currentClient, {headers:{authorization:'Basic '+adminAuth}})
    .then(r=>r.json())
    .then(arr=>{
      let html = '';
      arr.forEach(m=>{
        let bubble = m.msg.startsWith('img:') ? `<img src="${m.msg.slice(4)}" alt="img">` : m.msg.replace(/</g,'&lt;').replace(/\n/g,'<br>');
        if (m.role === 'user') html += `<div class="cskh-msg"><div class="bubble">${bubble}</div></div>`;
        else html += `<div class="cskh-msg user"><div class="bubble">${bubble}</div></div>`;
      });
      document.getElementById('adminMsgs').innerHTML = html;
      document.getElementById('adminMsgs').scrollTop = document.getElementById('adminMsgs').scrollHeight;
      pollTyping();
    });
}
document.getElementById('adminInputForm').onsubmit = function(e) {
  e.preventDefault();
  let msg = document.getElementById('adminMsgInput').value.trim();
  if (!msg) return;
  fetch('/api/adminsend', {
    method:'POST',
    headers:{'Content-Type':'application/json',authorization:'Basic '+adminAuth},
    body: JSON.stringify({clientId:currentClient, msg})
  }).then(()=>{document.getElementById('adminMsgInput').value='';loadChat();autoResize();});
  sendTyping(false);
};
document.getElementById('adminMsgInput').addEventListener('input', ()=>{
  sendTyping(document.getElementById('adminMsgInput').value.length > 0);
  autoResize();
});
function autoResize() {
  let input = document.getElementById('adminMsgInput');
  input.style.height = "auto";
  input.style.height = (input.scrollHeight) + "px";
}
function sendTyping(typing) {
  if (!currentClient) return;
  fetch('/api/admintyping', {
    method:'POST',
    headers:{'Content-Type':'application/json',authorization:'Basic '+adminAuth},
    body: JSON.stringify({clientId:currentClient, typing})
  });
}
document.getElementById('adminImgInput').onchange = function() {
  if (!this.files[0]) return;
  let fd = new FormData();
  fd.append('file', this.files[0]);
  fetch('/api/upload', {method:'POST', body:fd})
    .then(r=>r.json())
    .then(data=>{
      if (data.url) {
        fetch('/api/adminsend', {
          method:'POST',
          headers:{'Content-Type':'application/json',authorization:'Basic '+adminAuth},
          body: JSON.stringify({clientId:currentClient, msg:'img:' + data.url})
        }).then(()=>loadChat());
      }
    });
};
document.querySelector('#adminInputForm label').onclick = ()=>document.getElementById('adminImgInput').click();

let pollTimer = null;
function pollUserList() {
  loadUserList();
  pollTimer = setTimeout(pollUserList, 2000);
}
let pollTypingTimer = null;
function pollTyping() {
  fetch('/api/allchats', {headers:{authorization:'Basic '+adminAuth}})
    .then(r=>r.json()).then(list=>{
      let chat = list.find(c=>c.clientId===currentClient);
      document.getElementById('adminOnlineDot').className = 'dot' + (chat && chat.online ? '' : ' offline');
      document.getElementById('adminTyping').style.display = (chat && chat.typing) ? '' : 'none';
      pollTypingTimer = setTimeout(pollTyping, 1200);
    });
}
window.loginAdmin = loginAdmin;
window.openChat = openChat;
</script>
</body>
</html>
