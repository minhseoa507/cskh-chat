<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>CSKH Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    .cskh-chat { max-height: 350px; min-height: 220px; }
    .cskh-input { position: sticky; bottom: 0; background: #fff; }
    @media (max-width: 600px) {
      .cskh-chat { max-height: 250px; }
    }
  </style>
</head>
<body>
<div class="cskh-box">
  <div class="cskh-header">
    <span>ðŸ’¬ CSKH Online</span>
  </div>
  <div id="login" class="cskh-login">
    <h3>ChÃ o báº¡n! Vui lÃ²ng nháº­p tÃªn Ä‘á»ƒ báº¯t Ä‘áº§u chat</h3>
    <input type="text" id="nameInput" placeholder="Nháº­p tÃªn cá»§a báº¡n...">
    <button onclick="startChat()">OK</button>
  </div>
  <div id="chat" style="display:none;flex:1;flex-direction:column;">
    <div id="chatbox" class="cskh-chat"></div>
    <div id="typing" class="cskh-typing" style="display:none;">
      <span>CSKH Ä‘ang nháº­p</span>
      <span class="cskh-typing-dot"></span><span class="cskh-typing-dot"></span><span class="cskh-typing-dot"></span>
    </div>
    <form id="inputForm" class="cskh-input" autocomplete="off">
      <label>
        <input type="file" id="imgInput" accept="image/*" style="display:none;">
        <span>ðŸ“Ž</span>
      </label>
      <textarea id="msgInput" placeholder="Nháº­p tin nháº¯n..." autocomplete="off" rows="1" style="resize:none;flex:1;border:1px solid #e5e7eb;border-radius:7px;padding:10px 13px;font-size:1rem;"></textarea>
      <button type="submit">Gá»­i</button>
    </form>
  </div>
</div>
<script>
let clientId = localStorage.getItem('cskh_clientId') || (Date.now() + Math.random().toString(36).slice(2));
localStorage.setItem('cskh_clientId', clientId);
let name = localStorage.getItem('cskh_name') || '';
const chatbox = document.getElementById('chatbox');
const loginDiv = document.getElementById('login');
const chatDiv = document.getElementById('chat');
const msgInput = document.getElementById('msgInput');
const typingDiv = document.getElementById('typing');
const imgInput = document.getElementById('imgInput');

function startChat() {
  name = document.getElementById('nameInput').value.trim();
  if (!name) return alert('Vui lÃ²ng nháº­p tÃªn!');
  localStorage.setItem('cskh_name', name);
  loginDiv.style.display = 'none';
  chatDiv.style.display = 'flex';
  loadHistory();
  poll();
}
if (name) { loginDiv.style.display = 'none'; chatDiv.style.display = 'flex'; loadHistory(); poll(); }

function loadHistory() {
  fetch(`/api/history?clientId=${clientId}`).then(r=>r.json()).then(arr=>{
    chatbox.innerHTML = '';
    arr.forEach(showMsg);
    chatbox.scrollTop = chatbox.scrollHeight;
  });
}
function showMsg(m) {
  let html = '';
  if (m.role === 'user') html += `<div class="cskh-msg user"><div class="bubble">${msgHtml(m)}</div></div>`;
  else html += `<div class="cskh-msg"><div class="bubble">${msgHtml(m)}</div></div>`;
  chatbox.insertAdjacentHTML('beforeend', html);
}
function msgHtml(m) {
  if (m.msg && m.msg.startsWith('img:')) {
    return `<img src="${m.msg.slice(4)}" alt="image">`;
  }
  return m.msg.replace(/</g,'&lt;').replace(/\n/g,'<br>');
}

document.getElementById('inputForm').onsubmit = function(e) {
  e.preventDefault();
  let msg = msgInput.value.trim();
  if (!msg) return;
  sendMsg(msg, 'user');
  msgInput.value = '';
  sendTyping(false);
  autoResize();
};
msgInput.addEventListener('input', ()=>{
  sendTyping(msgInput.value.length > 0);
  autoResize();
});
function autoResize() {
  msgInput.style.height = "auto";
  msgInput.style.height = (msgInput.scrollHeight) + "px";
}
function sendMsg(msg, role) {
  fetch('/api/send', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({name, msg, role, clientId})
  }).then(()=>loadHistory());
}
function sendTyping(typing) {
  fetch('/api/send', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({name, clientId, typing, role:'user'})
  });
}
imgInput.onchange = function() {
  if (!imgInput.files[0]) return;
  let fd = new FormData();
  fd.append('file', imgInput.files[0]);
  fetch('/api/upload', {method:'POST', body:fd})
    .then(r=>r.json())
    .then(data=>{
      if (data.url) sendMsg('img:' + data.url, 'user');
    });
};
document.querySelector('.cskh-input label').onclick = ()=>imgInput.click();

let polling = null;
function poll() {
  fetch(`/api/history?clientId=${clientId}`).then(r=>r.json()).then(arr=>{
    const oldLen = chatbox.children.length;
    if (arr.length !== oldLen) {
      chatbox.innerHTML = '';
      arr.forEach(showMsg);
      chatbox.scrollTop = chatbox.scrollHeight;
    }
  });
  fetch(`/api/allchats`, {headers:{authorization:'Basic ' + btoa('admin:adminpass')}})
    .then(r=>r.json()).then(list=>{
      let chat = list.find(c=>c.clientId===clientId);
      if (chat && chat.typing) {
        typingDiv.style.display = '';
      } else {
        typingDiv.style.display = 'none';
      }
    });
  polling = setTimeout(poll, 1200);
}
</script>
</body>
</html>
